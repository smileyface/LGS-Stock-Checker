name: AI Traceability Check

on:
  pull_request:
    types: [opened, synchronize]
    branches: [ master ] # Or 'main'

permissions:
  contents: read      # To read the code
  pull-requests: write # To post a comment

jobs:
  traceability-check:
    runs-on: ubuntu-latest
    steps:
      # 1. Check out code (we need the full history to compare)
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches full history for a better diff

      # 2. Read your SRD file into an output variable
      - name: Read Software Requirements
        id: srd
        run: |
          srd_content=$(cat docs/srd.md)
          echo "srd_content<<EOF" >> $GITHUB_OUTPUT
          echo "$srd_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 3. Get the diff of this PR and store it
      - name: Get PR Diff
        id: diff
        run: |
          diff_content=$(git diff origin/${{ github.base_ref }}...${{ github.head_ref }})
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$diff_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      # 4. Run the Gemini CLI with all our context
      - name: Run Gemini AI Review
        id: gemini-review
        uses: google-github-actions/run-gemini-cli@v1
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are a senior software engineer performing a Requirements Traceability check.
            Your SOLE task is to validate that the code changes in the provided DIFF
            directly satisfy the requirements listed in the SRD.

            ## Software Requirements (from docs/srd.md):
            ${{ steps.srd.outputs.srd_content }}

            ## PR Title and Body:
            "${{ github.event.pull_request.title }} - ${{ github.event.pull_request.body }}"

            ## PR Code Diff:
            ```diff
            ${{ steps.diff.outputs.diff_content }}
            ```

            ## Your Instructions:
            1.  Analyze the provided code diff.
            2.  Analyze the PR title and body.
            3.  Compare the diff and PR body against the Software Requirements.
            4.  Check the test files in the diff to see if there is a test case for the requirement.
            
            ## Your Comment (Respond with ONLY this):
            Provide a clear "Traceability Analysis" in your comment.
            - Start with "✅ **Traceability Satisfied**" if the code AND tests clearly map to a requirement mentioned in the PR.
            - Start with "⚠️ **Traceability Check: NEEDS CLARIFICATION**" if the code seems to make changes but the PR body doesn't specify *which* requirement is being met.
            - Clearly state *which* requirement(s) you believe are affected.
            - **Always** remind the author to update the 'docs/traceability_matrix.md' file.
            
      # 5. Post the Gemini's response as a PR comment
      - name: Post Comment to PR
        uses: github-actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `${{ steps.gemini-review.outputs.gemini_response }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });