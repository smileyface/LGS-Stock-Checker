{% extends "base.html" %}

{% block title %}Account Settings{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Account Settings</h1>
    <p class="mb-4">Logged in as: <strong>{{ username }}</strong></p>

    <h2>Update Username</h2>
    <form id="username_form" class="mb-4">
        <div class="input-group mb-2">
            <input type="text" class="form-control" id="new_username" placeholder="New Username">
            <button type="button" class="btn btn-primary" onclick="updateUsername()">Update</button>
        </div>
    </form>

    <h2>Update Password</h2>
    <form id="password_form" class="mb-4">
        <div class="row g-2 mb-2">
            <div class="col">
                <input type="password" class="form-control" id="current_password" placeholder="Current Password">
            </div>
            <div class="col">
                <input type="password" class="form-control" id="new_password" placeholder="New Password">
            </div>
        </div>
        <button type="button" class="btn btn-primary" onclick="updatePassword()">Update</button>
    </form>

<h2>Update Preferred Stores</h2>
<form id="stores_form" class="mb-4">
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th scope="col">Store Name</th>
                <th scope="col" class="text-center">Track</th>
            </tr>
        </thead>
        <tbody>
            {% for store in all_stores %}
            <tr>
                <td>{{ store }}</td>
                <td class="text-center">
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input store-toggle" type="checkbox"
                            id="store_{{ loop.index }}" value="{{ store }}"
                            {% if store in stores %}checked{% endif %}>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="button" class="btn btn-primary mt-2" onclick="updateStores()">Save Stores</button>
</form>

</div>

<script>
    function updateUsername() {
        fetch("{{ url_for('user_bp.change_username') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ new_username: document.getElementById("new_username").value })
        }).then(response => response.json()).then(data => alert(data.message || data.error));
    }

    function updatePassword() {
        fetch("{{ url_for('user_bp.change_username') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                current_password: document.getElementById("current_password").value,
                new_password: document.getElementById("new_password").value
            })
        }).then(response => response.json()).then(data => alert(data.message || data.error));
    }

    function updateStores() {
        let selectedStores = Array.from(document.querySelectorAll(".store-toggle:checked")).map(el => el.value);
        fetch("{{ url_for('user_bp.update_stores') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ stores: selectedStores })
        }).then(response => response.json()).then(data => alert(data.message || data.error));
    }

</script>
{% endblock %}
