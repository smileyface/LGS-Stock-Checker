<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LGS Stock Checker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <script>
        var socket = io();

        socket.on('connect', function() {
            console.log("Connected to server");
            socket.emit('get_cards');
        });

        socket.on('cards_data', function(data) {
            if (data.error) {
                document.getElementById("cardTableBody").innerHTML = `<tr><td colspan="5">${data.error}</td></tr>`;
            } else {
                let tableHTML = "";
                data.cards.forEach((card, index) => {
                    tableHTML += `
                        <tr data-index="${index}">
                            <td>${card.amount}</td>
                            <td>${card.card_name}</td>
                            <td>${card.set_code || "N/A"}</td>
                            <td>${card.collector_id || "N/A"}</td>
                            <td>${card.finish}</td>
                        </tr>`;
                });
                document.getElementById("cardTableBody").innerHTML = tableHTML;
            }
        });

        function saveCards() {
            let cardInput = document.getElementById("new_card").value;
            socket.emit('save_cards', { cards: [cardInput] });
        }
    </script>
</head>
<body>
    <div class="container mt-4">
        <h1>Dashboard</h1>
        <p>Welcome, <strong>{{ username }}</strong>!</p>

        <h2>Your Tracked Cards</h2>

        <div class="mb-3">
            <input type="text" id="searchBar" class="form-control" placeholder="Search for a card..." onkeyup="filterCards()">
        </div>

        <table class="table table-striped" id="cardTable">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Card Name</th>
                    <th>Set Code</th>
                    <th>Collector Number</th>
                    <th>Finish</th>
                </tr>
            </thead>
            <tbody id="cardTableBody">
                <tr><td colspan="5">Loading...</td></tr>
            </tbody>
        </table>

        <h3>Add a New Card</h3>
        <div class="input-group mb-3">
            <input type="text" id="new_card" class="form-control" placeholder="Enter card details">
            <button class="btn btn-primary" onclick="saveCards()">Save</button>
        </div>

        <a href="{{ url_for('account_settings') }}" class="btn btn-secondary">Account Settings</a>
    </div>

    <script>
        function filterCards() {
            let input = document.getElementById("searchBar").value.toLowerCase();
            let rows = document.querySelectorAll("#cardTable tbody tr");

            rows.forEach(row => {
                let cardName = row.cells[1].innerText.toLowerCase();
                row.style.display = cardName.includes(input) ? "" : "none";
            });
        }
    </script>
</body>
</html>
